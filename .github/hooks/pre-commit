#!/bin/sh
#
# Pre-commit hook to detect potentially malicious content in markdown files
# This helps prevent script injection and data exfiltration attacks
#
# Install: Run .github/scripts/setup-hooks.sh or manually copy to .git/hooks/
#

# Colors for output (works on most terminals)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

printf "ğŸ” Running security scan on staged markdown files...\n"

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|markdown)$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
    printf "${GREEN}âœ“ No markdown files staged for commit${NC}\n"
    exit 0
fi

FOUND_ISSUES=0

printf "Scanning files:\n"
for file in $STAGED_MD_FILES; do
    printf "  - %s\n" "$file"
done
printf "\n"

# Function to check a pattern
check_pattern() {
    pattern="$1"
    description="$2"
    file="$3"
    
    if grep -n -i "$pattern" "$file" 2>/dev/null; then
        printf "${RED}âš ï¸  SECURITY ISSUE in %s${NC}\n" "$file"
        printf "   Pattern: ${YELLOW}%s${NC}\n" "$pattern"
        printf "   Risk: %s\n\n" "$description"
        return 1
    fi
    return 0
}

# Check each file for suspicious patterns
for file in $STAGED_MD_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Script injection
    check_pattern "<script" "Script tag injection" "$file" || FOUND_ISSUES=1
    check_pattern "</script" "Script tag injection" "$file" || FOUND_ISSUES=1
    
    # Data exfiltration
    check_pattern "fetch(" "Fetch API call (potential data exfiltration)" "$file" || FOUND_ISSUES=1
    check_pattern "XMLHttpRequest" "XMLHttpRequest (potential data exfiltration)" "$file" || FOUND_ISSUES=1
    
    # Code execution
    check_pattern "eval(" "Eval function (code execution)" "$file" || FOUND_ISSUES=1
    
    # DOM manipulation
    check_pattern "document\.write" "Document.write (DOM manipulation)" "$file" || FOUND_ISSUES=1
    check_pattern "document\.cookie" "Cookie access" "$file" || FOUND_ISSUES=1
    
    # Storage access
    check_pattern "localStorage" "LocalStorage access" "$file" || FOUND_ISSUES=1
    check_pattern "sessionStorage" "SessionStorage access" "$file" || FOUND_ISSUES=1
    
    # Location manipulation
    check_pattern "window\.location" "Location manipulation" "$file" || FOUND_ISSUES=1
    
    # Iframe injection
    check_pattern "<iframe" "Iframe injection" "$file" || FOUND_ISSUES=1
    
    # JavaScript protocol
    check_pattern "javascript:" "JavaScript protocol handler" "$file" || FOUND_ISSUES=1
    
    # Inline event handlers
    check_pattern "onclick=" "Inline event handler" "$file" || FOUND_ISSUES=1
    check_pattern "onerror=" "Inline error handler" "$file" || FOUND_ISSUES=1
    check_pattern "onload=" "Inline load handler" "$file" || FOUND_ISSUES=1
    check_pattern "onmouseover=" "Inline mouse handler" "$file" || FOUND_ISSUES=1
done

# Check for base64 encoded content (potential obfuscation)
for file in $STAGED_MD_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Look for atob/btoa functions (base64 encode/decode)
    if grep -n -E "(atob|btoa)\(" "$file" 2>/dev/null; then
        printf "${YELLOW}âš ï¸  WARNING: Base64 encoding functions in %s${NC}\n" "$file"
        printf "   This could be obfuscated malicious code. Please review.\n\n"
        FOUND_ISSUES=1
    fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
    printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    printf "${RED}COMMIT BLOCKED: Security issues detected in markdown files${NC}\n"
    printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    printf "\n"
    printf "Please remove the suspicious content before committing.\n"
    printf "If this is a false positive, you can bypass with: git commit --no-verify\n"
    printf "\n"
    exit 1
fi

printf "${GREEN}âœ“ Security scan passed - no issues found${NC}\n"
exit 0
